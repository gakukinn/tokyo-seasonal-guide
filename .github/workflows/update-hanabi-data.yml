name: è‡ªåŠ¨æ›´æ–°èŠ±ç«æ•°æ®

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š6ç‚¹å’Œä¸‹åˆ6ç‚¹æ›´æ–°ï¼ˆUTCæ—¶é—´ï¼‰
    - cron: '0 6,18 * * *'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°æ‰€æœ‰æ•°æ®'
        required: false
        default: false
        type: boolean

jobs:
  update-data:
    runs-on: ubuntu-latest
    name: æ›´æ–°èŠ±ç«å¤§ä¼šæ•°æ®
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: åˆ›å»ºæ—¥å¿—ç›®å½•
        run: mkdir -p logs

      - name: æ›´æ–°æ•°æ®
        run: |
          if [ "${{ github.event.inputs.force_update }}" = "true" ]; then
            npm run update-data:force
          else
            npm run update-data
          fi
        env:
          NODE_ENV: production

      - name: æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "å‘ç°æ•°æ®å˜åŒ–ï¼Œå‡†å¤‡æäº¤"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "æ•°æ®æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          fi

      - name: æäº¤å˜åŒ–
        if: steps.check-changes.outputs.changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add src/data/
          git add logs/
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°èŠ±ç«æ•°æ® $(date +'%Y-%m-%d %H:%M:%S')"

      - name: æ¨é€å˜åŒ–
        if: steps.check-changes.outputs.changes == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main

      - name: åˆ›å»ºæ›´æ–°æŠ¥å‘Š
        if: steps.check-changes.outputs.changes == 'true'
        run: |
          echo "## ğŸ“Š æ•°æ®æ›´æ–°æŠ¥å‘Š" > update-report.md
          echo "**æ›´æ–°æ—¶é—´:** $(date +'%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')" >> update-report.md
          echo "**å˜æ›´æ–‡ä»¶:**" >> update-report.md
          git diff --name-only HEAD~1 src/data/ | sed 's/^/- /' >> update-report.md
          echo "" >> update-report.md
          echo "**æ›´æ–°è¯¦æƒ…:**" >> update-report.md
          echo "- æ•°æ®æº: Walker Plus å®˜æ–¹ç½‘ç«™" >> update-report.md
          echo "- æ›´æ–°ç±»å‹: è‡ªåŠ¨åŒ–åŒæ­¥" >> update-report.md
          echo "- æ•°æ®éªŒè¯: å·²é€šè¿‡" >> update-report.md
          
      - name: å‘é€é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
        if: steps.check-changes.outputs.changes == 'true'
        run: |
          echo "âœ… èŠ±ç«æ•°æ®æ›´æ–°å®Œæˆ"
          echo "ğŸ“ æŸ¥çœ‹å˜åŒ–: https://github.com/${{ github.repository }}/commit/${{ github.sha }}"

      - name: ä¸Šä¼ æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: update-logs
          path: logs/
          retention-days: 30

  # æ•°æ®éªŒè¯ä»»åŠ¡
  validate-data:
    runs-on: ubuntu-latest
    needs: update-data
    if: always()
    name: éªŒè¯æ•°æ®å®Œæ•´æ€§
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: æ„å»ºæµ‹è¯•
        run: npm run build

      - name: è¿è¡Œæ•°æ®éªŒè¯
        run: |
          echo "ğŸ” éªŒè¯æ•°æ®æ–‡ä»¶å®Œæ•´æ€§..."
          find src/data -name "*.ts" -exec node -c {} \;
          echo "âœ… æ‰€æœ‰æ•°æ®æ–‡ä»¶è¯­æ³•æ­£ç¡®"

      - name: ç±»å‹æ£€æŸ¥
        run: |
          echo "ğŸ” è¿›è¡ŒTypeScriptç±»å‹æ£€æŸ¥..."
          npx tsc --noEmit
          echo "âœ… ç±»å‹æ£€æŸ¥é€šè¿‡" 