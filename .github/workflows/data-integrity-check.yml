name: æ•°æ®å®Œæ•´æ€§å¼ºåˆ¶éªŒè¯

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**/*.ts'
      - 'src/**/*.js'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**/*.ts'
      - 'src/**/*.js'

jobs:
  data-integrity-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        npm ci
        npm install ajv ajv-formats
        
    - name: è¿è¡Œæ•°æ®å®Œæ•´æ€§éªŒè¯
      run: |
        echo "ğŸš¨ å¼€å§‹å¼ºåˆ¶æ•°æ®å®Œæ•´æ€§éªŒè¯..."
        node scripts/enforce-data-integrity.js
        
    - name: ä¸Šä¼ éªŒè¯æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: data-integrity-report
        path: data-integrity-report.json
        
    - name: éªŒè¯å¤±è´¥å¤„ç†
      if: failure()
      run: |
        echo "âŒ æ•°æ®å®Œæ•´æ€§éªŒè¯å¤±è´¥ï¼"
        echo "ğŸ“‹ æœªé€šè¿‡éªŒè¯çš„æ–‡ä»¶åŒ…å«ä»¥ä¸‹é—®é¢˜ï¼š"
        echo "  - ç¼ºå°‘ officialSource å­—æ®µ"
        echo "  - ç¼ºå°‘ Walker Plus å®˜æ–¹é“¾æ¥éªŒè¯"
        echo "  - ç¼ºå°‘ç”¨æˆ·ç¡®è®¤ä¿¡æ¯"
        echo ""
        echo "ğŸ”§ ä¿®å¤æ–¹æ³•ï¼š"
        echo "1. ä¸ºæ¯ä¸ªèŠ±ç«æ•°æ®æ–‡ä»¶æ·»åŠ  officialSource éªŒè¯å­—æ®µ"
        echo "2. å‘ç”¨æˆ·è¯·æ±‚ Walker Plus å®˜æ–¹é“¾æ¥"
        echo "3. è®°å½•ç”¨æˆ·éªŒè¯å’Œç¡®è®¤ä¿¡æ¯"
        echo "4. é‡æ–°æäº¤ä»£ç "
        echo ""
        echo "âš ï¸  é‡è¦æé†’ï¼šç»ä¸å…è®¸æäº¤æœªç»å®˜æ–¹éªŒè¯çš„èŠ±ç«æ•°æ®ï¼"
        exit 1 