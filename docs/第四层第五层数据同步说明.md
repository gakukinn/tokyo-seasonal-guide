# 第四层和第五层数据同步功能说明

## 概述

第四层和第五层数据同步系统确保花火大会的基本信息在不同层级页面间保持一致。系统以第五层详细数据为准，自动同步到第四层卡片显示，同时保持红心数的独立性。

## 功能特点

- ✅ **智能数据同步**：以第五层为数据源，自动更新第四层信息
- ✅ **保持红心数独立**：红心数不参与同步，保持点击+1逻辑
- ✅ **自动备份机制**：更新前自动备份原数据
- ✅ **差异检测**：只在数据发生变化时才执行同步
- ✅ **完整验证**：同步后自动验证结果

## 同步字段

### 会同步的字段：
1. **标题** (`name`) - 花火大会名称
2. **日期** (`date`) - 举办日期（自动转换为简短格式）
3. **地点** (`location`) - 主要会场地址
4. **访客数** (`visitors`) - 预期访客人数
5. **花火数** (`fireworks`) - 花火发数

### 不会同步的字段：
- **红心数** (`likes`) - 保持独立的点击+1逻辑
- **图片** (`imageUrl`) - 保持第四层独立配置
- **分类** (`category`) - 保持第四层独立配置
- **其他元数据** - 保持各层级独立配置

## 使用方法

### 1. 手动同步
```bash
npm run sync-layers
```
立即执行一次数据同步，完成后显示验证结果。

### 2. 仅验证同步状态
```bash
npm run sync-layers:validate
```
检查当前同步状态，不执行实际同步操作。

## 工作流程

### 数据流向
```
第五层详细数据 (level5-september-tokyo-chofu-hanabi.ts)
    ↓ 提取基本信息
    ↓ 检测数据差异
    ↓ 自动备份原数据
    ↓ 更新第四层数据
第四层卡片数据 (level4-september-tokyo-hanabi.ts)
```

### 同步逻辑
1. **数据提取**：从第五层文件中提取关键信息
2. **差异检测**：对比第四层和第五层的数据差异
3. **备份保护**：更新前自动创建备份文件
4. **精确更新**：只更新有差异的字段
5. **验证确认**：同步后验证结果正确性

## 日期格式转换

系统会自动将第五层的完整日期格式转换为第四层的简短格式：

- **第五层格式**：`2025年9月20日(土)`
- **第四层格式**：`9月20日`

## 数据备份

每次同步前，系统会自动创建备份文件：
- **格式**：`level4-september-tokyo-hanabi.ts.backup.时间戳`
- **位置**：与原文件相同目录
- **用途**：数据恢复和版本对比

## 日志记录

### 同步日志
- **位置**：`logs/layer-sync.log`
- **内容**：详细的同步操作记录
- **格式**：时间戳 + 操作信息

### 验证结果
同步完成后会显示详细的验证结果：
```
=== 同步验证结果 ===
标题同步: 第40回调布花火 ✓
日期同步: 9月20日 ✓
花火数: 约12000发 ✓
访客数: 35万人 ✓
红心数: 0 (保持独立) ✓
===================
```

## 红心数独立性

### 为什么红心数保持独立？
1. **用户交互数据**：红心数反映用户的实际互动
2. **实时性要求**：需要即时响应用户点击
3. **数据完整性**：避免被官方数据覆盖
4. **用户体验**：保持点击+1的即时反馈

### 红心数的工作机制
- 初始值：0
- 用户点击：+1
- 防重复：同一用户只能点击一次
- 持久化：数据保存在第四层文件中
- 独立性：不受数据同步影响

## 扩展功能

### 添加新的花火大会同步

1. 在 `LayerDataSync` 类中添加新的同步方法：
```javascript
async syncNewHanabi() {
  // 实现新花火大会的同步逻辑
}
```

2. 在 `syncAllEvents()` 方法中调用：
```javascript
await this.syncNewHanabi();
```

### 自定义同步字段

修改 `extractLevel5Data()` 和 `updateLevel4Data()` 方法来添加新的同步字段。

## 故障排除

### 同步失败
1. 检查文件路径是否正确
2. 确认文件权限是否足够
3. 查看 `logs/layer-sync.log` 错误信息

### 数据不一致
1. 运行 `npm run sync-layers:validate` 检查状态
2. 手动运行 `npm run sync-layers` 强制同步
3. 检查第五层数据格式是否正确

### 恢复备份数据
```bash
# 找到备份文件
ls src/data/*.backup.*

# 恢复备份（替换时间戳）
cp src/data/level4-september-tokyo-hanabi.ts.backup.1749336589022 src/data/level4-september-tokyo-hanabi.ts
```

## 最佳实践

1. **定期同步**：建议在更新第五层数据后立即运行同步
2. **验证结果**：每次同步后检查验证结果
3. **备份管理**：定期清理过期的备份文件
4. **测试环境**：在生产环境前先在测试环境验证

## 技术架构

- **语言**：Node.js
- **文件操作**：原生 fs 模块
- **正则匹配**：精确的字段提取和替换
- **备份机制**：时间戳命名的自动备份
- **日志系统**：文件追加写入

## 安全性

- 只修改指定的同步字段
- 自动备份防止数据丢失
- 完整的操作日志审计
- 红心数保护机制 