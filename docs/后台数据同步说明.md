# 后台数据同步功能说明

## 概述

后台数据同步系统是一个纯后台运行的服务，自动从官方数据源获取最新的花火大会信息并更新本地数据文件。该系统不显示任何前端UI界面，完全在后台静默运行。

## 功能特点

- ✅ **纯后台运行**：无前端UI，不影响用户体验
- ✅ **自动数据获取**：从官方网站获取最新信息
- ✅ **智能更新检测**：只在数据发生变化时才更新
- ✅ **自动备份**：更新前自动备份原数据
- ✅ **完整日志记录**：记录所有同步操作
- ✅ **多种运行模式**：单次、监控、每日定时

## 使用方法

### 1. 单次同步
```bash
npm run sync-data
```
立即执行一次数据同步，完成后自动退出。

### 2. 每周同步模式（推荐）
```bash
npm run sync-data:weekly
```
启动每周同步模式，每7天自动检查一次数据更新。

### 3. 监控模式
```bash
npm run sync-data:watch
```
启动监控模式，每7天自动检查一次数据更新（与weekly模式相同）。

### 4. 每日定时同步
```bash
npm run sync-data:daily
```
启动每日定时同步，每天凌晨2点自动执行同步。

## 日志文件

### 同步日志
- **位置**：`logs/background-sync.log`
- **内容**：详细的同步操作记录
- **格式**：时间戳 + 操作信息

### 同步历史
- **位置**：`logs/last-sync.json`
- **内容**：最近100次同步记录
- **用途**：追踪数据变化历史

## 数据备份

每次更新数据前，系统会自动创建备份文件：
- **格式**：`原文件名.backup.时间戳`
- **位置**：与原数据文件相同目录
- **用途**：数据恢复和版本对比

## 支持的花火大会

目前支持以下花火大会的自动同步：

1. **调布花火2025**
   - 数据文件：`level5-september-tokyo-chofu-hanabi.ts`
   - 官方源：hanabi.walkerplus.com
   - 同步字段：日期、时间、地点、花火数量、访客数
   - **不同步字段**：红心数（保持原有数值）

## 扩展说明

### 添加新的花火大会同步

1. 在 `BackgroundDataSync` 类中添加新的同步方法
2. 在 `syncAllEvents()` 方法中调用新方法
3. 配置对应的官方数据源URL

### 自定义同步频率

修改 `startWatchMode()` 方法中的 `syncInterval` 变量：
```javascript
const syncInterval = 7 * 24 * 60 * 60 * 1000; // 7天（毫秒）
```

### 自定义每日同步时间

修改 `startDailyMode()` 方法中的时间设置：
```javascript
tomorrow.setHours(2, 0, 0, 0); // 凌晨2点
```

## 注意事项

1. **网络连接**：需要稳定的网络连接访问官方数据源
2. **文件权限**：确保有读写数据文件和日志文件的权限
3. **进程管理**：长期运行建议使用进程管理工具（如PM2）
4. **错误处理**：同步失败不会影响现有数据，只会记录错误日志

## 故障排除

### 同步失败
1. 检查网络连接
2. 查看 `logs/background-sync.log` 错误信息
3. 确认官方数据源URL是否有效

### 数据未更新
1. 检查是否真的有数据变化
2. 查看同步历史记录 `logs/last-sync.json`
3. 手动运行单次同步测试

### 恢复备份数据
```bash
# 找到备份文件
ls src/data/*.backup.*

# 恢复备份（替换时间戳）
cp src/data/level5-september-tokyo-chofu-hanabi.ts.backup.1749336160737 src/data/level5-september-tokyo-chofu-hanabi.ts
```

## 技术架构

- **语言**：Node.js
- **HTTP客户端**：原生 https 模块
- **文件操作**：原生 fs 模块
- **日志系统**：文件追加写入
- **定时任务**：setInterval / setTimeout
- **进程管理**：信号处理（SIGINT/SIGTERM）

## 安全性

- 只读取官方公开数据源
- 不存储敏感信息
- 自动备份防止数据丢失
- 完整的操作日志审计 